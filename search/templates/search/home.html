{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mayele - Research Assistant</title>
    <link rel="icon" type="image/png" href="{% static 'images/mayele_logo.png' %}">
    <style>
        *{
            margin:0;
            padding:0;
            box-sizing:
            border-box
        }

        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
            height:100vh;
            overflow:hidden;
            background:#f7f7f8
        }

        .app-container {
            display:flex;
            height:100vh
        }

        /* Left Sidebar - Collapsible */
        .sidebar {
            width:70px;
            background:#1a1a1a;
            border-right:1px solid #2a2a2a;
            display:flex;
            flex-direction:column;
            transition:width .28s ease, box-shadow .2s;position:relative;z-index:100
        }

        .sidebar.expanded {
            width:280px;
            box-shadow:0 6px 20px rgba(0,0,0,.08)
        }

        .sidebar-header {
            padding:20px 0;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:15px;
            border-bottom:1px solid #2a2a2a
        }

        .sidebar-logo {
            width:40px;
            height:40px;
            display:flex;align-items:center;
            justify-content:center
        }

        .sidebar-logo img {
            width:100%;
            height:100%;
            object-fit:contain
        }
        .sidebar-logo .logo-fallback {
            font-size:24px
        }

        .new-chat-btn {
            width:40px;
            height:40px;
            border-radius:10px;
            border:1px solid #3a3a3a;
            background:transparent;
            color:#fff;
            cursor:pointer;
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .2s
        }
        .new-chat-btn:hover {
            background:#2a2a2a;
            border-color:#4a4a4a
        }

        .sidebar-content {
            flex:1;overflow:hidden;
            display:flex;
            flex-direction:column
        }
        .sidebar-nav {
            flex:1;
            overflow-y:auto;
            padding:10px 0
        }

        /* NAV ITEMS */
        .nav-item {
            display:flex;
            align-items:center;
            padding: 12px 0px;
            color:#fff;
            cursor:pointer;
            transition:all .12s;
            white-space:nowrap;
            border-radius:8px;
            margin:4px 8px;
            background:transparent;
        }
        .nav-item .nav-icon {            
            width:56px;
            min-width:56px;
            height:40px;
            font-size:32px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .nav-icon img {
            width:26px;
            height:40px;
            object-fit:contain;
            filter:brightness(0) invert(1);
            transition:filter 0.12s;
        }
        .nav-item:hover .nav-icon img {
            filter:brightness(0) invert(1);
        }
        .nav-icon .fallback-icon {
            font-size:32px;
            filter:grayscale(1) brightness(2);
        }
        .nav-item .nav-label {
            opacity:0;
            margin-left:10px;
            font-size:14px;
            font-weight:500;
            transition:opacity .18s ease
        }
        .nav-item:hover {
            background:#2a2a2a;
            color:#fff;
        }
        .nav-item.active {
            background:transparent;
            color:#fff;
        }
        .settings-item {
            margin-top:auto;
            border-top:1px solid #2a2a2a;
            padding-top:20px !important;
        }

        /* IMPORTANT: do NOT expand sidebar on .sidebar:hover ‚Äî expansion is controlled by JS only */
        /* Sections are hidden by default and shown when .nav-section.active is set by JS */
        .nav-section {
            display:none;
            padding-left:50px;
            max-height:0;
            overflow:hidden;
            transition:max-height .28s ease
        }
        .nav-section.active {
            display:block;
            max-height:420px;
            overflow-y:auto
        }

        /* Titles + items inside sections */
        .section-title {
            font-size:11px;
            text-transform:uppercase;
            color:#6a6a6a;
            padding:10px 15px 5px;
            font-weight:600;
            letter-spacing:.5px
        }
        .section-group {
            margin-bottom:20px
            }
        .section-item {
            padding:8px 15px;
            color:#9a9a9a;
            font-size:13px;
            cursor:pointer;
            border-radius:6px;
            margin:2px 10px;
            transition:all .12s;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap
        }
        .section-item:hover {
            background:#3a3a3a;
            color:#fff
        }

        /* Scrollbar styling */
        .sidebar-nav::-webkit-scrollbar,
        .nav-section::-webkit-scrollbar {
            width:4px;
        }
        .sidebar-nav::-webkit-scrollbar-track,
        .nav-section::-webkit-scrollbar-track {
            background:transparent;
        }
        .sidebar-nav::-webkit-scrollbar-thumb,
        .nav-section::-webkit-scrollbar-thumb {
            background:#3a3a3a;
            border-radius:2px;
        }

        /* Main content */
        .main-content {
            flex:1;
            display:flex;
            flex-direction:column;
            max-width:100%
        }

        /* Top bar */
        .top-bar {
            height:60px;
            background:#fff;
            border-bottom:1px solid #e5e5e5;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 20px
        }
        .top-bar-left {
            display:flex;align-items:center;gap:12px
        }
        .user-avatar {
            width:36px;
            height:36px;
            border-radius:50%;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:600;
            font-size:16px
        }
        .conversation-title {
            font-size:16px;
            font-weight:600;
            color:#333;
            padding:6px 12px;
            border-radius:6px;
            cursor:default
        }
        .top-bar-right {
            display:flex;
            align-items:center;
            gap:10px
        }
        .top-bar-btn {
            width:36px;
            height:36px;
            border-radius:8px;
            border:none;
            background:transparent;
            color:#666;
            cursor:pointer;
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .12s
        }

        /* Dropdown */
        .dropdown-menu {
            position:absolute;
            top:50px;
            right:20px;
            background:white;
            border:1px solid #e5e5e5;
            border-radius:8px;
            box-shadow:0 4px 12px rgba(0,0,0,.1);
            min-width:200px;
            display:none;
            z-index:1000
        }
        .dropdown-menu.active {
            display:block
        }
        .dropdown-item {
            padding:12px 16px;
            font-size:14px;
            color:#333;
            cursor:pointer;
            transition:all .12s;
            border-bottom:1px solid #f0f0f0
        }
        .dropdown-item:last-child {
            border-bottom:none
        }
        .dropdown-item:hover {
            background:#f7f7f8
        }
        .dropdown-item.danger {
            color:#e53e3e
        }
        .dropdown-item.danger:hover {
            background:#fff5f5
        }

        /* Chat area */
        .chat-container {
            flex:1;
            display:flex;
            flex-direction:column;
            overflow:hidden
        }
        .chat-messages {
            flex:1;
            overflow-y:auto;
            padding:40px 20px;
            display:flex;
            flex-direction:column;
            gap:20px
        }
        .message {
            display:flex;
            gap:12px;
            max-width:80%;
            animation:fadeIn .3s ease-in
        }
        @keyframes fadeIn {
            from{opacity:0;
            transform:translateY(10px)}to{opacity:1;
            transform:translateY(0)}
        }
        .message.user {
            align-self:flex-end;
            flex-direction:row-reverse
        }
        .message.agent {
            align-self:flex-start
        }
        .message-avatar {
            width:36px;
            height:36px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center
        }
        .message-avatar img {
            width:100%;
            height:100%;
            border-radius:50%;
            object-fit:cover;
        }
        .message.user .message-avatar {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white
        }
        .message.agent .message-avatar {
            background:#f0f0f0;
            color:#333
        }
        .message-content {
            background:white;
            padding:12px 16px;
            border-radius:18px;
            box-shadow:0 1px 2px rgba(0,0,0,.05);
            line-height:1.5
        }
        .message.user .message-content {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white
        }
        .message.agent .message-content {
            background:white;
            color:#333;
            border:1px solid #e5e5e5
        }

        /* Paper cards inside messages */
        .paper-card {
            background:#fafafa;
            border:1px solid #e5e5e5;
            border-radius:12px;
            padding:16px;
            margin-top:8px
        }
        .paper-card-title {
            font-weight:600;
            font-size:1rem;
            color:#1a1a1a;
            margin-bottom:8px;
            line-height:1.4;
            text-align:center;
        }
        .paper-card-meta {
            font-size:.85rem;
            color:#666;
            margin-bottom:8px
        }
        .paper-card-abstract {
            font-size:.9rem;
            color:#4a4a4a;
            line-height:1.5;
            margin-bottom:12px
        }
        .paper-card-button {
            display:inline-block;
            padding:8px 16px;
            background:#5f6fc6;
            color:white;
            border:none;
            border-radius:8px;
            font-size:.9rem;
            cursor:pointer;
            text-decoration:none
            /* text-align: center; */
        }
        .paper-card-button:hover {
            background:#4d5fb5
        }

        /* Paper Card Actions */
        .paper-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .paper-card-actions .paper-card-button {
            flex: 2;
            text-align: center;
        }

        .citation-btn {
            background: #10b981 !important;
            flex: 1;
            font-size: 0.85rem !important;
            padding: 8px 12px !important;
        }

        .citation-btn:hover {
            background: #059669 !important;
        }

        /* Pagination Styles */
        .papers-container {
            position: relative;
            min-height: 400px;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding: 12px 0;
        }

        .pagination-arrow {
            background: white;
            border: 2px solid #5f6fc6;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #5f6fc6;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pagination-arrow:hover {
            background: #5f6fc6;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(95,111,198,0.3);
        }

        .pagination-arrow:active {
            transform: scale(0.95);
        }

        .pagination-arrow.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .no-results-message {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #4a4a4a;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

        .no-results-message h4 {
            margin-bottom: 8px;
            color: #5f6fc6;
            font-size: 1.1rem;
        }

        .no-results-message p {
            margin: 0;
            font-size: 0.95rem;
            color: #555;
        }

        /* Citation Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .citation-modal-content {
            padding: 0;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .citation-styles {
            display: flex;
            gap: 8px;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .citation-style-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: #6b7280;
        }

        .citation-style-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .citation-style-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .citation-output-container {
            padding: 20px 24px;
            min-height: 150px;
        }

        .citation-output {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #1f2937;
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal-actions {
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modal-btn:hover {
            background: #f3f4f6;
        }

        .modal-btn.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .modal-btn.primary:hover {
            background: #2563eb;
        }

        /* Upload Modal Styles */
        .upload-modal-content {
            max-width: 500px;
        }

        .upload-options {
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .upload-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .upload-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 10px;
        }

        .upload-text {
            flex: 1;
        }

        .upload-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .upload-desc {
            font-size: 13px;
            color: #6b7280;
        }

        .upload-note {
            padding: 16px 24px;
            background: #f0f9ff;
            color: #1e40af;
            text-align: center;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
        }

        /* Center + button vertically */
        .input-plus-button {
            align-self: center;
        }

        /* Share Modal Styles */
        .share-modal-content {
            max-width: 550px;
        }

        .share-content {
            padding: 20px 24px;
        }

        .share-description {
            color: #4b5563;
            font-size: 15px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .share-link-container {
            margin-bottom: 20px;
        }

        .share-link-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #1f2937;
            background: #f9fafb;
            cursor: text;
            transition: all 0.2s;
        }

        .share-link-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
        }

        .share-link-input:hover {
            border-color: #d1d5db;
        }

        .share-info {
            background: #f0f9ff;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .share-info p {
            margin: 0;
            font-size: 13px;
            color: #1e40af;
            line-height: 1.6;
        }

        .share-info p + p {
            margin-top: 8px;
        }

        /* Settings Modal Styles */
        .settings-modal-content {
            max-width: 400px;
        }

        .settings-options {
            padding: 12px;
        }

        .settings-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .settings-option:hover {
            background: #f3f4f6;
        }

        .settings-option.danger-option:hover {
            background: #fee2e2;
        }

        .settings-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .settings-text {
            flex: 1;
        }

        .settings-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .settings-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .danger-option .settings-title {
            color: #dc2626;
        }

        /* Welcome */
        .welcome-message {
            text-align:center;
            padding:60px 20px;
            color:#666
        }
        .welcome-logo {
            width:100px;
            height:100px;
            margin:0 auto 20px;
            display:flex;
            align-items:center;
            justify-content:center
        }
        .welcome-logo img {
            width:100%;
            height:100%;
            object-fit:contain
        }
        .welcome-message h2 {
            font-size:1.8rem;
            color:#333;
            margin-bottom:10px
        }
        .welcome-suggestions {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            justify-content:center;
            margin-top:30px
        }
        .suggestion-chip {
            padding:12px 24px;
            background:white;
            border:1px solid #e5e5e5;
            border-radius:20px;
            cursor:pointer;
            font-size:.9rem;
            color:#666;
            transition:all .12s
        }
        .suggestion-chip:hover {
            background:#5f6fc6;
            color:white;
            border-color:#5f6fc6;
            transform:translateY(-2px)
        }

        /* Input area - vertically center + button */
        .chat-input-container {
            padding:20px;
            background:white;
            border-top:1px solid #e5e5e5
        }
        .chat-input-wrapper {
            max-width:900px;
            margin:0 auto;
            display:flex;
            gap:10px;
            align-items:center
        }
        .input-plus-button {
            width:40px;
            height:40px;
            border-radius:50%;
            border:1px solid #e5e5e5;
            background:white;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:20px;
            color:#666;
            transition:all .12s;
            flex-shrink:0
        }
        .input-plus-button:hover {
            background:#f0f0f0;border-color:#ccc
        }

        /* textarea */
        #user-input {
            flex:1;
            padding:12px 16px;
            border:1px solid #e5e5e5;
            border-radius:24px;
            font-size:.95rem;
            outline:none;
            transition:border-color .12s;
            background:#fafafa;
            resize:none;
            min-height:44px;
            max-height:200px;
            font-family:inherit;
            line-height:1.5
        }
        #user-input:focus {
            border-color:#5f6fc6;
            background:white
        }
        #send-btn {
            width:40px;
            height:40px;
            border-radius:50%;
            border:none;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
            cursor:pointer;
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:transform .12s;
            flex-shrink:0
        }
        #send-btn:hover {
            transform:scale(1.05)
        }
        #send-btn:active {
            transform:scale(.95)
        }

        /* typing indicator */
        .typing-indicator {
            display:none;
            padding:12px 16px;
            background:white;
            border:1px solid #e5e5e5;
            border-radius:18px;
            width:fit-content
        }
        .typing-indicator.active {
            display:flex;
            gap:4px
        }
        .typing-dot {
            width:8px;
            height:8px;
            border-radius:50%;
            background:#999;
            animation:typing 1.4s infinite
        }
        .typing-dot:nth-child(2) {
            animation-delay:.2s
        }
        .typing-dot:nth-child(3) {
            animation-delay:.4s
        }
        @keyframes typing {
            0%,60%,100%{transform:translateY(0);
            opacity:.7}30%{transform:translateY(-10px);
            opacity:1}
        }

        /* toast */
        .toast {
            position:fixed;
            bottom:30px;
            right:30px;
            background:#333;
            color:white;
            padding:12px 20px;
            border-radius:8px;
            box-shadow:0 4px 12px rgba(0,0,0,.3);
            z-index:10000;
            animation:slideIn .3s ease-out;
            display:none
        }
        .toast.active {
            display:block
        }
        @keyframes slideIn {
            from{transform:translateY(100px);
            opacity:0}to{transform:translateY(0);
            opacity:1}
        }

        /* main chat scrollbar */
        .chat-messages::-webkit-scrollbar {
            width:6px
        }
        .chat-messages::-webkit-scrollbar-track {
            background:transparent
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background:#d0d0d0;
            border-radius:3px
        }
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background:#b0b0b0
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="{% static 'images/mayele_logo.png' %}" alt="Mayele" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-fallback" style="display:none;">üî¨</div>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()" title="New conversation">+</button>
            </div>

            <div class="sidebar-content">
                <div class="sidebar-nav">
                    <!-- Chats Section -->
                    <div class="nav-item" id="nav-chats" title="View conversation history">
                        <span class="nav-icon">
                          <img src="{% static 'images/chats.png' %}" alt="üí¨" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                          <span class="fallback-icon" style="display:none;">üí¨</span>
                        </span>
                        <span class="nav-label">Chats</span>
                    </div>
                      
                    <div class="nav-section" id="chats-section">
                        <div class="section-group">
                            <div class="section-title">This Month</div>
                            <div class="section-item" onclick="loadConversation('conv1')">Machine Learning in Healthcare</div>
                            <div class="section-item" onclick="loadConversation('conv2')">Quantum Computing Overview</div>
                            <div class="section-item" onclick="loadConversation('conv3')">Climate Change Impact Studies</div>
                        </div>
                        <div class="section-group">
                            <div class="section-title">Last Month</div>
                            <div class="section-item" onclick="loadConversation('conv4')">Neural Networks Research</div>
                            <div class="section-item" onclick="loadConversation('conv5')">AI Ethics Papers</div>
                        </div>
                        <div class="section-group">
                            <div class="section-title">01/2025</div>
                            <div class="section-item" onclick="loadConversation('conv6')">Blockchain Technology</div>
                            <div class="section-item" onclick="loadConversation('conv7')">Renewable Energy Sources</div>
                        </div>
                    </div>

                    <!-- History Section -->
                    <div class="nav-item" id="nav-history" title="View papers you've read">
                        <span class="nav-icon">
                          <img src="{% static 'images/history.png' %}" alt="üìú" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                          <span class="fallback-icon" style="display:none;">üìú</span>
                        </span>
                        <span class="nav-label">Paper History</span>
                    </div>
                      
                    <div class="nav-section" id="history-section">
                        <div class="section-group">
                            <div class="section-title">This Month</div>
                            <div class="section-item" onclick="openPaper('paper1')">Deep Learning for Medical Diagnosis</div>
                            <div class="section-item" onclick="openPaper('paper2')">Quantum Supremacy Achieved</div>
                            <div class="section-item" onclick="openPaper('paper3')">Climate Models and Predictions</div>
                        </div>
                        <div class="section-group">
                            <div class="section-title">Last Month</div>
                            <div class="section-item" onclick="openPaper('paper4')">Transformer Architecture Explained</div>
                            <div class="section-item" onclick="openPaper('paper5')">Ethics in AI Development</div>
                        </div>
                        <div class="section-group">
                            <div class="section-title">01/2025</div>
                            <div class="section-item" onclick="openPaper('paper6')">Decentralized Finance Overview</div>
                        </div>
                    </div>
                </div>

                <!-- Settings at bottom -->
                <div class="nav-item settings-item" id="nav-settings" title="Settings and options" onclick="toggleDropdown()">
                    <span class="nav-icon">
                      <img src="{% static 'images/settings.png' %}" alt="‚öôÔ∏è" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                      <span class="fallback-icon" style="display:none;">‚öôÔ∏è</span>
                    </span>
                    <span class="nav-label">Settings</span>
                </div>
                  
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <div class="user-avatar">Z</div>
                    <div class="conversation-title" id="conversation-title">New Conversation</div>
                </div>
                <div class="top-bar-right">
                    <button class="top-bar-btn" onclick="shareConversation()" title="Share">
                        <img src="{% static 'images/share.png' %}" alt="üîó" class="top-bar-icon">
                    </button>
                    <button class="top-bar-btn" onclick="toggleDropdown()" title="More options">‚ãÆ</button>
                </div>
            </div>

            <!-- Dropdown Menu (hidden, replaced by modal) -->
            <div class="dropdown-menu" id="dropdown-menu" style="display:none;"></div>

            <!-- Chat Area -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- Welcome Message -->
                    <div class="welcome-message">
                        <div class="welcome-logo">
                            <img src="{% static 'images/mayele_logo.png' %}" alt="Mayele" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="logo-fallback" style="display:none;">üî¨</div>
                        </div>
                        <h2>Welcome to Mayele</h2>
                        <p>Your AI research assistant. Ask me to find academic papers!</p>
                        <div class="welcome-suggestions">
                            <div class="suggestion-chip" onclick="sendSuggestion('Papers on machine learning in healthcare')">
                                Papers on machine learning in healthcare
                            </div>
                            <div class="suggestion-chip" onclick="sendSuggestion('Recent advances in quantum computing')">
                                Recent advances in quantum computing
                            </div>
                            <div class="suggestion-chip" onclick="sendSuggestion('Haitian Revolution impact')">
                                Haitian Revolution impact
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                {% csrf_token %}
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <div class="input-plus-button" title="Attach file" onclick="toggleUploadModal()">Ôºã</div>
                        <textarea
                            id="user-input"
                            placeholder="Ask about research papers..."
                            rows="1"
                        ></textarea>
                        <button id="send-btn" onclick="sendMessage()" title="Send">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Citation Modal -->
    <div id="citation-modal" class="modal" style="display:none;" onclick="if(event.target === this) closeCitationModal()">
        <div class="modal-content citation-modal-content">
            <div class="modal-header">
                <h3>üìö Get Citation</h3>
                <button class="modal-close" onclick="closeCitationModal()">√ó</button>
            </div>
            
            <div class="citation-styles">
                <button class="citation-style-btn active" onclick="generateCitation(currentPaperIndex, 'apa'); setActiveStyle(this)">APA</button>
                <button class="citation-style-btn" onclick="generateCitation(currentPaperIndex, 'mla'); setActiveStyle(this)">MLA</button>
                <button class="citation-style-btn" onclick="generateCitation(currentPaperIndex, 'chicago'); setActiveStyle(this)">Chicago</button>
                <button class="citation-style-btn" onclick="generateCitation(currentPaperIndex, 'ieee'); setActiveStyle(this)">IEEE</button>
            </div>
            
            <div class="citation-output-container">
                <div id="citation-output" class="citation-output">Select a citation style above</div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="copyCitation()">üìã Copy</button>
                <button class="modal-btn" onclick="closeCitationModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="modal" style="display:none;" onclick="if(event.target === this) toggleUploadModal()">
        <div class="modal-content upload-modal-content">
            <div class="modal-header">
                <h3>üìé Attach Files</h3>
                <button class="modal-close" onclick="toggleUploadModal()">√ó</button>
            </div>
            
            <div class="upload-options">
                <div class="upload-option" onclick="alert('Document upload coming soon!')">
                    <div class="upload-icon">üìÑ</div>
                    <div class="upload-text">
                        <div class="upload-title">Documents</div>
                        <div class="upload-desc">PDF, DOCX, TXT</div>
                    </div>
                </div>
                
                <div class="upload-option" onclick="alert('Image upload coming soon!')">
                    <div class="upload-icon">üñºÔ∏è</div>
                    <div class="upload-text">
                        <div class="upload-title">Images</div>
                        <div class="upload-desc">PNG, JPG, GIF</div>
                    </div>
                </div>
                
                <div class="upload-option" onclick="alert('Data file upload coming soon!')">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">
                        <div class="upload-title">Data Files</div>
                        <div class="upload-desc">CSV, XLSX, JSON</div>
                    </div>
                </div>
                
                <div class="upload-option" onclick="alert('URL paste coming soon!')">
                    <div class="upload-icon">üîó</div>
                    <div class="upload-text">
                        <div class="upload-title">Paste URL</div>
                        <div class="upload-desc">Web link or DOI</div>
                    </div>
                </div>
            </div>
            
            <div class="upload-note">
                ‚ÑπÔ∏è File upload functionality coming soon
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal" style="display:none;" onclick="if(event.target === this) closeShareModal()">
        <div class="modal-content share-modal-content">
            <div class="modal-header">
                <h3>üîó Share Conversation</h3>
                <button class="modal-close" onclick="closeShareModal()">√ó</button>
            </div>
            
            <div class="share-content">
                <p class="share-description">Share this conversation with anyone using the link below:</p>
                
                <div class="share-link-container">
                    <input 
                        type="text" 
                        id="share-link-input" 
                        class="share-link-input" 
                        readonly 
                        value="Generating link..."
                    />
                </div>
                
                <div class="share-info">
                    <p>üîí Anyone with this link can view this conversation</p>
                    <p>üìä View count will be tracked</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="copyShareLink()">üìã Copy Link</button>
                <button class="modal-btn" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" style="display:none;" onclick="if(event.target === this) closeSettingsModal()">
        <div class="modal-content settings-modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            
            <div class="settings-options">
                <div class="settings-option" onclick="clearCurrentConversation()">
                    <div class="settings-icon">üóëÔ∏è</div>
                    <div class="settings-text">
                        <div class="settings-title">Clear Conversation</div>
                        <div class="settings-desc">Remove current chat</div>
                    </div>
                </div>
                
                <div class="settings-option" onclick="exportConversation()">
                    <div class="settings-icon">üìÑ</div>
                    <div class="settings-text">
                        <div class="settings-title">Export</div>
                        <div class="settings-desc">Download as text file</div>
                    </div>
                </div>
                
                <div class="settings-option" onclick="archiveConversation()">
                    <div class="settings-icon">üì¶</div>
                    <div class="settings-text">
                        <div class="settings-title">Archive</div>
                        <div class="settings-desc">Coming soon</div>
                    </div>
                </div>
                
                <div class="settings-option danger-option" onclick="deleteAllHistory()">
                    <div class="settings-icon">‚ö†Ô∏è</div>
                    <div class="settings-text">
                        <div class="settings-title">Delete All</div>
                        <div class="settings-desc">Permanently remove history</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAYELE_AVATAR_URL = "{% static 'images/mayele_avatar.png' %}";

        let lastSearchResults = [];
        let currentResultsPage = 0;
        let currentResultsMessageDiv = null;
        const PAPERS_PER_PAGE = 5;
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sidebar = document.querySelector('.sidebar');
        const chatsNav = document.getElementById('nav-chats');
        const historyNav = document.getElementById('nav-history');
        const chatsSection = document.getElementById('chats-section');
        const historySection = document.getElementById('history-section');

        let conversationStarted = false;

        // backup: ensure history label text change to "Paper History"
        const historyLabel = historyNav?.querySelector('.nav-label');
        if(historyLabel) historyLabel.textContent = 'Paper History';

        // -------------------- Sidebar hover logic --------------------
        // Sidebar reveal logic ‚Äî updated so lists stay open when hovered
        // Click-to-toggle sidebar logic
        let currentOpenSection = null;

        function toggleSection(sectionToShow) {
            if (currentOpenSection === sectionToShow) {
                // same section ‚Üí close it
                sidebar.classList.remove('expanded');
                sectionToShow.classList.remove('active');
                currentOpenSection = null;
                return;
            }

            // open new section
            sidebar.classList.add('expanded');
            chatsSection.classList.remove('active');
            historySection.classList.remove('active');
            sectionToShow.classList.add('active');
            currentOpenSection = sectionToShow;
        }

        // Apply to both icons
        chatsNav.addEventListener('click', () => toggleSection(chatsSection));
        historyNav.addEventListener('click', () => toggleSection(historySection));



        // -------------------- Messaging --------------------
        // Auto-grow textarea
        if (userInput) {
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });

            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">Z</div>
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addAgentMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent';
            const avatarHtml = `
                <div class="message-avatar">
                    <img src="${MAYELE_AVATAR_URL}" alt="Mayele" onerror="this.style.display='none'; this.parentNode.textContent='ü§ñ';">
                </div>`;
            messageDiv.innerHTML = `
                ${avatarHtml}
                <div class="message-content">${escapeHtml(text)}</div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function addTypingIndicator() {
            if (document.getElementById('typing-indicator')) return;
            const indicator = document.createElement('div');
            indicator.className = 'message agent';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = `
                <div class="message-avatar">
                    <img src="${MAYELE_AVATAR_URL}" alt="Mayele" onerror="this.style.display='none'; this.parentNode.textContent='ü§ñ';">
                </div>
                <div class="typing-indicator active">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `;
            chatMessages.appendChild(indicator);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Display papers with pagination support
        function displayPapers(papers) {
            lastSearchResults = Array.isArray(papers) ? papers : [];
            currentResultsPage = 0; // Reset to first page

            // Remove any existing paginated results container
            if (currentResultsMessageDiv && currentResultsMessageDiv.parentNode) {
                currentResultsMessageDiv.parentNode.removeChild(currentResultsMessageDiv);
            }
            currentResultsMessageDiv = null;

            if (!lastSearchResults.length) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message agent';
                messageDiv.innerHTML = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="no-results-message">
                            <h4>No papers found</h4>
                            <p>Try refining your query or using different keywords. For example, specify a region, methodology, or time period.</p>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                scrollToBottom();
                return;
            }

            renderPapersPage(lastSearchResults, 0);
        }

        function renderPapersPage(papers, page) {
            const totalPages = Math.ceil(papers.length / PAPERS_PER_PAGE);
            const startIndex = page * PAPERS_PER_PAGE;
            const endIndex = Math.min(startIndex + PAPERS_PER_PAGE, papers.length);
            const papersForPage = papers.slice(startIndex, endIndex);

            // Create message div if it doesn't exist (first time)
            if (!currentResultsMessageDiv) {
                currentResultsMessageDiv = document.createElement('div');
                currentResultsMessageDiv.className = 'message agent';
                currentResultsMessageDiv.innerHTML = '<div class="message-avatar">ü§ñ</div><div class="message-content"><div class="papers-container"></div></div>';
                chatMessages.appendChild(currentResultsMessageDiv);
            }

            const container = currentResultsMessageDiv.querySelector('.papers-container');
            let papersHtml = '<div class="papers-page">';

            papersForPage.forEach((paper, localIndex) => {
                const globalIndex = startIndex + localIndex; // Actual index in lastSearchResults
                const stars = '‚≠ê'.repeat(paper.relevance_score || 3);
                papersHtml += `
                    <div class="paper-card">
                        <div class="paper-card-title">${escapeHtml(paper.title || '')}</div>
                        <div class="paper-card-meta">
                            <strong>Authors:</strong> ${escapeHtml(paper.authors || '')} |
                            <strong>Source:</strong> ${(paper.source||'').toUpperCase()} |
                            ${paper.year || 'N/A'} ${stars}
                        </div>
                        <div class="paper-card-abstract">${escapeHtml((paper.abstract||'').substring(0,200))}...</div>
                        <div class="paper-card-actions">
                            <a href="${paper.link || '#'}" target="_blank" class="paper-card-button" onclick="savePaperClick(${globalIndex}); return true;">Read Paper</a>
                            <button class="paper-card-button citation-btn" onclick="showCitationModal(${globalIndex})">Get Citation</button>
                        </div>
                    </div>
                `;
            });

            papersHtml += '</div>';

            // Add pagination controls if more than 5 papers
            if (papers.length > PAPERS_PER_PAGE) {
                const hasNext = page < totalPages - 1;
                const hasPrev = page > 0;
                
                papersHtml += `
                    <div class="pagination-controls">
                        <button class="pagination-arrow ${!hasPrev ? 'disabled' : ''}" 
                                onclick="goToPage(${page - 1})" 
                                ${!hasPrev ? 'disabled' : ''}
                                aria-label="Previous page">
                            ‚Üê
                        </button>
                        <span class="pagination-info">
                            Page ${page + 1} of ${totalPages} (${startIndex + 1}-${endIndex} of ${papers.length})
                        </span>
                        <button class="pagination-arrow ${!hasNext ? 'disabled' : ''}" 
                                onclick="goToPage(${page + 1})" 
                                ${!hasNext ? 'disabled' : ''}
                                aria-label="Next page">
                            ‚Üí
                        </button>
                    </div>
                `;
            }

            container.innerHTML = papersHtml;
            scrollToBottom();
        }

        function goToPage(page) {
            if (page < 0 || page >= Math.ceil(lastSearchResults.length / PAPERS_PER_PAGE)) {
                return;
            }
            currentResultsPage = page;
            renderPapersPage(lastSearchResults, page);
        }

        // Make goToPage globally available
        window.goToPage = goToPage;

        // Core sendMessage function ‚Äî fixes missing/broken logic so messages appear
        async function sendMessage() {
            const message = (userInput?.value || '').trim();
            if (!message) {
                addAgentMessage('Please enter a message before sending.');
                return;
            }

            // Remove welcome block if present
            const welcome = document.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            // Set conversation title on first message
            if (!conversationStarted) {
                const title = message.length > 40 ? message.substring(0,40) + '...' : message;
                const titleEl = document.getElementById('conversation-title');
                if (titleEl) titleEl.textContent = title;
                conversationStarted = true;
            }

            // Add user message to UI
            addUserMessage(message);
            // clear input
            if (userInput) { userInput.value = ''; userInput.style.height = 'auto'; }

            // typing indicator
            addTypingIndicator();

            try {
                // Get CSRF token from Django template tag
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

                // Prepare form data for backend API
                const formData = new FormData();
                formData.append('message', message);
                if (csrfToken) {
                    formData.append('csrfmiddlewaretoken', csrfToken);
                }

                // Call backend API
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                removeTypingIndicator();

                // Handle different response types
                if (data.error) {
                    addAgentMessage(`Error: ${data.error}`);
                } else if (data.action === 'search' && data.data && data.data.results) {
                    // Search results with papers
                    addAgentMessage(data.agent_response);
                    displayPapers(data.data.results);
                } else if (data.action === 'clarification') {
                    // Query needs clarification
                    addAgentMessage(data.agent_response);
                    if (data.data && data.data.suggestions && data.data.suggestions.length > 0) {
                        let suggestionsText = "\n\nSuggestions:\n";
                        data.data.suggestions.forEach((suggestion, index) => {
                            suggestionsText += `${index + 1}. ${suggestion}\n`;
                        });
                        addAgentMessage(suggestionsText);
                    }
                } else if (data.agent_response) {
                    // Regular conversational response
                    addAgentMessage(data.agent_response);
                } else {
                    addAgentMessage('I received your message but got an unexpected response.');
                }

            } catch (err) {
                console.error('sendMessage error', err);
                removeTypingIndicator();
                addAgentMessage('Sorry, I encountered an error connecting to the server. Please check your connection and try again.');
            }
        }

        // helper to wire suggestion chips if present (they call sendMessage with text auto-filled)
        function sendSuggestion(text) {
            if (userInput) {
                userInput.value = text;
                // optionally trigger input event to resize
                userInput.dispatchEvent(new Event('input'));
                sendMessage();
            }
        }

        // New conversation function
        function startNewChat() {
            // Clear chat messages
            chatMessages.innerHTML = '';
            
            // Reset conversation state
            conversationStarted = false;
            
            // Reset pagination state
            lastSearchResults = [];
            currentResultsPage = 0;
            currentResultsMessageDiv = null;
            
            // Reset title
            const titleEl = document.getElementById('conversation-title');
            if (titleEl) titleEl.textContent = 'New Conversation';
            
            // Add welcome message back
            const welcomeHtml = `
                <div class="welcome-message">
                    <div class="welcome-logo">
                        <img src="{% static 'images/mayele_logo.png' %}" alt="Mayele" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="logo-fallback" style="display:none;">üî¨</div>
                    </div>
                    <h2>Welcome to Mayele</h2>
                    <p>Your AI research assistant. Ask me to find academic papers!</p>
                    <div class="welcome-suggestions">
                        <div class="suggestion-chip" onclick="sendSuggestion('Papers on machine learning in healthcare')">
                            Papers on machine learning in healthcare
                        </div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Recent advances in quantum computing')">
                            Recent advances in quantum computing
                        </div>
                        <div class="suggestion-chip" onclick="sendSuggestion('Haitian Revolution impact')">
                            Haitian Revolution impact
                        </div>
                    </div>
                </div>
            `;
            chatMessages.innerHTML = welcomeHtml;
            
            // Clear input
            if (userInput) {
                userInput.value = '';
                userInput.style.height = 'auto';
            }
        }

        // Make startNewChat globally available
        window.startNewChat = startNewChat;

        // ==================== CITATION MODAL FUNCTIONS ====================
        let currentPaperIndex = 0;

        function showCitationModal(paperIndex) {
            currentPaperIndex = paperIndex;
            const paper = lastSearchResults[paperIndex];
            if (!paper) {
                alert('Paper not found');
                return;
            }
            
            document.getElementById('citation-modal').style.display = 'flex';
            generateCitation(paperIndex, 'apa'); // Default to APA
        }

        function closeCitationModal() {
            document.getElementById('citation-modal').style.display = 'none';
        }

        async function generateCitation(paperIndex, style) {
            const citationOutput = document.getElementById('citation-output');
            citationOutput.textContent = 'Generating citation...';
            
            try {
                const response = await fetch('/api/citations/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `indices[]=${paperIndex}&style=${style}`
                });
                
                const data = await response.json();
                if (data.citations && data.citations.length > 0) {
                    citationOutput.textContent = data.citations[0];
                } else {
                    citationOutput.textContent = 'Error generating citation';
                }
            } catch (error) {
                citationOutput.textContent = 'Error: ' + error.message;
            }
        }

        function setActiveStyle(btn) {
            document.querySelectorAll('.citation-style-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function copyCitation() {
            const citationText = document.getElementById('citation-output').textContent;
            navigator.clipboard.writeText(citationText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // ==================== PAPER HISTORY FUNCTIONS ====================
        function savePaperClick(paperIndex) {
            try {
                const paper = lastSearchResults[paperIndex];
                if (!paper) {
                    console.error('Paper not found at index:', paperIndex);
                    return;
                }
                
                console.log('Saving paper to history:', paper.title);
                
                fetch('/api/save-paper/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(paper)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Paper saved successfully:', data);
                    // Reload paper history to show the new paper
                    loadPaperHistory();
                })
                .catch(err => console.error('Failed to save paper:', err));
            } catch(e) {
                console.error('Error saving paper:', e);
            }
        }

        // ==================== SHARE CONVERSATION FUNCTIONS ====================
        let currentShareUrl = '';

        async function shareConversation() {
            // Show modal immediately
            document.getElementById('share-modal').style.display = 'flex';
            document.getElementById('share-link-input').value = 'Generating link...';
            
            try {
                const response = await fetch('/api/share/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    currentShareUrl = data.share_url;
                    document.getElementById('share-link-input').value = data.share_url;
                    // Auto-select the text for easy copying
                    document.getElementById('share-link-input').select();
                } else {
                    document.getElementById('share-link-input').value = 'Error: Could not generate link';
                    console.error('Share error:', data);
                }
            } catch (error) {
                console.error('Share error:', error);
                document.getElementById('share-link-input').value = 'Error: Failed to create share link';
            }
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function copyShareLink() {
            const input = document.getElementById('share-link-input');
            input.select();
            
            navigator.clipboard.writeText(currentShareUrl).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#10b981';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        // ==================== UPLOAD MODAL FUNCTIONS ====================
        function toggleUploadModal() {
            const modal = document.getElementById('upload-modal');
            if (modal.style.display === 'none' || !modal.style.display) {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        // ==================== LOAD HISTORY FUNCTIONS ====================
        async function loadChatHistory() {
            try {
                const response = await fetch('/api/chat-history/');
                const data = await response.json();
                
                const chatsSection = document.getElementById('chats-section');
                chatsSection.innerHTML = ''; // Always clear mock data
                
                if (data.history && data.history.length > 0) {
                    // Group by date
                    const grouped = {};
                    data.history.forEach(chat => {
                        const date = new Date(chat.timestamp);
                        const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        if (!grouped[key]) grouped[key] = [];
                        grouped[key].push(chat);
                    });
                    
                    // Render grouped chats
                    for (const [period, chats] of Object.entries(grouped)) {
                        const groupHtml = `
                            <div class="section-group">
                                <div class="section-title">${period}</div>
                                ${chats.slice(0, 5).map((chat, idx) => `
                                    <div class="section-item" onclick="loadSpecificConversation(${idx}, '${period}')">
                                        ${chat.user_message.substring(0, 40)}${chat.user_message.length > 40 ? '...' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        chatsSection.innerHTML += groupHtml;
                        
                        // Store chat data for later retrieval
                        if (!window.chatHistoryData) window.chatHistoryData = {};
                        if (!window.chatHistoryData[period]) window.chatHistoryData[period] = [];
                        window.chatHistoryData[period] = chats;
                    }
                } else {
                    // Show empty state
                    chatsSection.innerHTML = `
                        <div class="section-group">
                            <div class="section-title" style="text-align: center; color: #666; padding: 20px;">
                                No conversations yet
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                const chatsSection = document.getElementById('chats-section');
                chatsSection.innerHTML = `
                    <div class="section-group">
                        <div class="section-title" style="text-align: center; color: #ef4444; padding: 20px;">
                            Error loading history
                        </div>
                    </div>
                `;
            }
        }

        async function loadPaperHistory() {
            try {
                const response = await fetch('/api/paper-history/');
                const data = await response.json();
                
                const historySection = document.getElementById('history-section');
                historySection.innerHTML = ''; // Always clear mock data
                
                if (data.history && data.history.length > 0) {
                    // Group by date
                    const grouped = {};
                    data.history.forEach(paper => {
                        const date = new Date(paper.timestamp);
                        const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        if (!grouped[key]) grouped[key] = [];
                        grouped[key].push(paper);
                    });
                    
                    // Render grouped papers
                    for (const [period, papers] of Object.entries(grouped)) {
                        const groupHtml = `
                            <div class="section-group">
                                <div class="section-title">${period}</div>
                                ${papers.slice(0, 5).map(paper => `
                                    <div class="section-item" onclick="window.open('${paper.link}', '_blank')">
                                        ${paper.title.substring(0, 50)}${paper.title.length > 50 ? '...' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        historySection.innerHTML += groupHtml;
                    }
                } else {
                    // Show empty state
                    historySection.innerHTML = `
                        <div class="section-group">
                            <div class="section-title" style="text-align: center; color: #666; padding: 20px;">
                                No papers saved yet
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading paper history:', error);
                const historySection = document.getElementById('history-section');
                historySection.innerHTML = `
                    <div class="section-group">
                        <div class="section-title" style="text-align: center; color: #ef4444; padding: 20px;">
                            Error loading history
                        </div>
                    </div>
                `;
            }
        }

        // Load histories on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory();
            loadPaperHistory();
        });

        // ==================== LOAD SPECIFIC CONVERSATION ====================
        function loadSpecificConversation(idx, period) {
            try {
                const chat = window.chatHistoryData[period][idx];
                if (!chat) {
                    alert('Conversation not found');
                    return;
                }
                
                // Clear current chat
                chatMessages.innerHTML = '';
                
                // Add the specific conversation's messages
                addUserMessage(chat.user_message);
                addAgentMessage(chat.agent_response);
                
                // Update title
                const title = chat.user_message.length > 40 ? chat.user_message.substring(0,40) + '...' : chat.user_message;
                document.getElementById('conversation-title').textContent = title;
                
                // Close sidebar on mobile
                sidebar.classList.remove('expanded');
                
                scrollToBottom();
            } catch (error) {
                console.error('Error loading conversation:', error);
                alert('Failed to load conversation');
            }
        }

        // ==================== SETTINGS MODAL FUNCTIONS ====================
        function toggleDropdown() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // ==================== DROPDOWN MENU FUNCTIONS ====================
        async function clearCurrentConversation() {
            if (!confirm('Are you sure you want to clear the current conversation? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    // Refresh the page to show empty conversation
                    window.location.reload();
                } else {
                    alert('Failed to clear conversation');
                }
            } catch (error) {
                console.error('Clear conversation error:', error);
                alert('Failed to clear conversation');
            }
            
            // Close settings modal
            closeSettingsModal();
        }

        function exportConversation() {
            // Get all messages from the chat
            const messages = [];
            document.querySelectorAll('.message').forEach(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.querySelector('.message-content');
                if (content) {
                    messages.push({
                        role: isUser ? 'User' : 'Assistant',
                        message: content.textContent.trim()
                    });
                }
            });
            
            // Create text export
            let exportText = '=== Mayele Conversation Export ===\\n\\n';
            exportText += `Date: ${new Date().toLocaleString()}\\n\\n`;
            exportText += messages.map(m => `[${m.role}]\\n${m.message}\\n`).join('\\n');
            
            // Download as text file
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mayele-conversation-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeSettingsModal();
        }

        function archiveConversation() {
            alert('Archive feature coming soon! This will let you save conversations for later reference.');
            closeSettingsModal();
        }

        async function deleteAllHistory() {
            const confirmed = confirm(
                '‚ö†Ô∏è WARNING: This will permanently delete ALL your conversation and paper history.\\n\\n' +
                'This action cannot be undone. Are you absolutely sure?'
            );
            
            if (!confirmed) {
                closeSettingsModal();
                return;
            }
            
            // Double confirmation
            const doubleConfirm = confirm('Last chance! Delete EVERYTHING?');
            if (!doubleConfirm) {
                closeSettingsModal();
                return;
            }
            
            try {
                // Clear conversation
                await fetch('/api/clear/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                
                alert('All history deleted. The page will now reload.');
                window.location.reload();
            } catch (error) {
                console.error('Delete history error:', error);
                alert('Failed to delete history');
            }
            
            closeSettingsModal();
        }

    </script>

</body>
</html>